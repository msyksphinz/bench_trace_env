name: SimPoint Analysis

on:
  workflow_dispatch:
    inputs:
      benchmark:
        description: 'Benchmark to run (e.g., 400.perlbench)'
        required: false
        default: '400.perlbench'
        type: string
      run_all:
        description: 'Run all benchmarks'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
      - master
  schedule:
    # Run regression test once per day at 2:00 AM JST (17:00 UTC previous day)
    - cron: '0 17 * * *'

env:
  SPEC_ROOT: spec2006_work/spec2006_installed
  RESULT_DIR: spec2006_work/results
  BBV_DIR: spec2006_work/bbv_results
  SIMPOINT_DIR: spec2006_work/simpoint_results

jobs:
  simpoint:
    runs-on: self-hosted
    timeout-minutes: 360  # 6 hours timeout
    container:
      image: simpoint-runner:latest
      volumes:
        - ${{ github.workspace }}:/workspace
      options: --workdir /workspace
    env:
      RISCV: /riscv-linux
      PATH: /workspace/qemu-9.2.4/build:/riscv-linux/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    
    steps:
    - name: Build Docker image (if not exists)
      run: |
        # Build Docker image if it doesn't exist on the server
        # This step runs on the host (not in container) to build the image
        if ! docker images simpoint-runner:latest | grep -q simpoint-runner; then
          docker build -t simpoint-runner:latest \
            --build-arg RISCV_ARG=/riscv-linux \
            -f Dockerfile .
        else
          echo "Docker image simpoint-runner:latest already exists on server"
        fi

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build QEMU
      run: |
        # Build QEMU (workspace is clean on each run)
        QEMU_VERSION=9.2.4
        wget https://download.qemu.org/qemu-${QEMU_VERSION}.tar.xz
        tar xJf qemu-${QEMU_VERSION}.tar.xz
        cd qemu-${QEMU_VERSION}
        mkdir -p build && cd build
        ../configure --target-list=riscv64-linux-user --prefix=$(pwd)
        make -j$(nproc)

    - name: Prepare SPEC CPU2006
      working-directory: spec2006_work
      run: |
        # Install SPEC CPU2006 (workspace is clean on each run)
        if [ ! -d "../spec2006_cdrom" ]; then
          echo "Error: spec2006_cdrom directory not found on server"
          exit 1
        fi
        cd ../spec2006_cdrom
        ./install.sh -f -d $(pwd)/../spec2006_work/spec2006_installed

    - name: Build benchmarks
      working-directory: spec2006_work
      run: |
        # For scheduled runs (regression), run all benchmarks
        RUN_ALL="${{ inputs.run_all || 'false' }}"
        BENCHMARK="${{ inputs.benchmark || '400.perlbench' }}"
        if [ "$RUN_ALL" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
          make build
        else
          make build_${BENCHMARK}
        fi

    - name: Run BBV collection
      working-directory: spec2006_work
      run: |
        # For scheduled runs (regression), run all benchmarks
        RUN_ALL="${{ inputs.run_all || 'false' }}"
        BENCHMARK="${{ inputs.benchmark || '400.perlbench' }}"
        if [ "$RUN_ALL" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
          make run_bbv
        else
          make run_bbv_${BENCHMARK}
        fi

    - name: Build SimPoint
      working-directory: spec2006_work
      run: |
        make build_simpoint

    - name: Run SimPoint analysis
      working-directory: spec2006_work
      run: |
        # For scheduled runs (regression), run all benchmarks
        RUN_ALL="${{ inputs.run_all || 'false' }}"
        BENCHMARK="${{ inputs.benchmark || '400.perlbench' }}"
        if [ "$RUN_ALL" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
          make run_simpoint
        else
          make run_simpoint_${BENCHMARK}
        fi

    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: simpoint-results
        path: |
          spec2006_work/simpoint_results/
          spec2006_work/bbv_results/
        retention-days: 30

    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs
        path: |
          spec2006_work/results/
        retention-days: 7

