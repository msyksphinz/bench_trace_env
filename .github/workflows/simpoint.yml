name: SimPoint Analysis

on:
  workflow_dispatch:
    inputs:
      benchmark:
        description: 'Benchmark to run (e.g., 400.perlbench)'
        required: false
        default: '400.perlbench'
        type: string
      run_all:
        description: 'Run all benchmarks'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
      - master
  schedule:
    # Run regression test once per day at 2:00 AM JST (17:00 UTC previous day)
    - cron: '0 17 * * *'

jobs:
  build-docker:
    runs-on: self-hosted
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        # Build Docker image from repository Dockerfile on the runner server
        docker build -t simpoint-runner:latest \
          --build-arg RISCV_ARG=/riscv-linux \
          -f Dockerfile .

  simpoint:
    runs-on: self-hosted
    needs: build-docker
    timeout-minutes: 360  # 6 hours timeout
    container:
      image: simpoint-runner:latest
      volumes:
        - ${{ github.workspace }}:/workspace
      options: --workdir /workspace
    env:
      RISCV: /riscv-linux
      PATH: /workspace/qemu-9.2.4/build:/riscv-linux/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Show hostname to confirm the command is executed in the container
      run: hostname
  